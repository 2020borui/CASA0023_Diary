<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>wk9_sar</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Wk9_SAR_files/libs/clipboard/clipboard.min.js"></script>
<script src="Wk9_SAR_files/libs/quarto-html/quarto.js"></script>
<script src="Wk9_SAR_files/libs/quarto-html/popper.min.js"></script>
<script src="Wk9_SAR_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Wk9_SAR_files/libs/quarto-html/anchor.min.js"></script>
<link href="Wk9_SAR_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Wk9_SAR_files/libs/quarto-html/quarto-syntax-highlighting-01c78b5cd655e4cd89133cf59d535862.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Wk9_SAR_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Wk9_SAR_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Wk9_SAR_files/libs/bootstrap/bootstrap-933a14f46f0e4d1503cecf416b5e09b4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="Wk9_SAR_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="Wk9_SAR_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">



</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="syntactic-aperture-radar" class="level1">
<h1>Syntactic Aperture Radar</h1>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<section id="sar-base-background-and-advantages" class="level3">
<h3 class="anchored" data-anchor-id="sar-base-background-and-advantages">SAR base background and advantages</h3>
<p>Synthetic Aperture Radar (SAR) is an active remote sensing sensor. Unlike passive sensors that rely on solar radiation, SAR actively emits its own electromagnetic waves and forms images by receiving the backscattered signals from the Earth’s surface. This mechanism makes SAR unaffected by cloud and weather, allowing for all-weather observation. SAR improves spatial resolution by synthesising backscatter from multiple observation angles as the sensor moves along its path. In Week 4, I analysed OE data related to flood monitoring. Compared to Landsat 8, SAR data provides greater continuity and reliability, especially in disaster scenarios. This is because SAR can penetrate cloud cover and reduce data loss caused by cloudy or rainy conditions.</p>
</section>
<section id="sar-data-types-and-parameter-selection" class="level3">
<h3 class="anchored" data-anchor-id="sar-data-types-and-parameter-selection">SAR data types and parameter selection</h3>
<p>SAR data characteristics are primarily defined by wavelength (band) and polarisation. Common bands include X, C, and L. Wavelength determines the radar’s penetration ability: short-wavelength bands (e.g., X-band) are suitable for monitoring surface features, while long-wavelength bands (e.g., L-band) can penetrate vegetation, allowing for the analysis of forest structure.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/sarband.png" class="img-fluid figure-img" width="500"></p>
<figcaption>SAR bands source:<a href="https://www.earthdata.nasa.gov/learn/earth-observation-data-basics/sar">NASA Earth Data</a></figcaption>
</figure>
</div>
<p>Polarisation refers to the orientation of the radar wave’s oscillation. Different surface types respond differently to each polarisation mode: VV is sensitive to rough surface scattering, while VH is better suited for detecting volume scattering (e.g., vegetation). The selection of band-polarisation combinations should be made with care for the specific analytical objective.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/SARPolarization.jpg" class="img-fluid figure-img" width="500"></p>
<figcaption>Polarisation source:<a href="https://www.earthdata.nasa.gov/learn/earth-observation-data-basics/sar">NASA Earth Data</a></figcaption>
</figure>
</div>
<p>SAR backscatter intensity can be expressed in three main formats: power, amplitude, and dB, each with different advantages and applications due to SAR’s wide dynamic range.</p>
<div class="cell" data-escape="false">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF; font-weight: bold;">Expression Format</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF; font-weight: bold;">Formula (Visual)</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF; font-weight: bold;">Advantages</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF; font-weight: bold;">Disadvantages</th>
<th data-quarto-table-cell-role="th" style="text-align: left; position: sticky; top: 0; background-color: #FFFFFF; font-weight: bold;">Suitable Use</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Power</td>
<td style="text-align: left;">I² + Q²</td>
<td style="text-align: left;">Most original and accurate representation of radar backscatter; linear values; suitable for statistical and ML analysis</td>
<td style="text-align: left;">Very small values; low contrast between bright and dark areas; poor for visualization</td>
<td style="text-align: left;">Data analysis, modeling, classification</td>
</tr>
<tr class="even">
<td style="text-align: left;">Amplitude</td>
<td style="text-align: left;">√(I² + Q²)</td>
<td style="text-align: left;">Natural-looking brightness range in images; easy for visual interpretation</td>
<td style="text-align: left;">Still linear; large dynamic range; less detail enhancement compared to dB</td>
<td style="text-align: left;">Image processing, visual analysis</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dB</td>
<td style="text-align: left;">10 × log₁₀(Power)</td>
<td style="text-align: left;">Compressed dynamic range; easier to observe details in dark regions (e.g., water); default format in GEE</td>
<td style="text-align: left;">Not linear; unsuitable for statistical/scientific calculation; bright areas may appear saturated</td>
<td style="text-align: left;">Image visualization; highlighting differences/contrast</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="sar-data-application" class="level3">
<h3 class="anchored" data-anchor-id="sar-data-application">SAR data application</h3>
<p>SAR applications often rely on comparing images acquired at different times. Differential InSAR (DInSAR) detects ground movement by measuring phase differences between two SAR images acquired at different times. It is commonly used to monitor earthquakes and land subsidence. There are several techniques for detecting changes using SAR data. Unlike optical data, SAR images cannot be simply subtracted due to their multiplicative noise and different statistical characteristics. Commonly used methods include ratio, improved ratio, and log-ratio techniques.</p>
<p>To enhance classification accuracy, SAR imagery is often fused with optical data. Fusion strategies—ranging from decision-level to pixel-level—combine the complementary strengths of both datasets. While decision-level fusion is more accessible and commonly used in GEE, I realised that more complex fusion techniques offer higher precision and will likely be essential in future applications such as agricultural monitoring.</p>
</section>
</section>
<section id="application" class="level2">
<h2 class="anchored" data-anchor-id="application">Application</h2>
<p>Remote sensing data play a vital role not only in scientific analysis but also in humanitarian disaster assessment. This week’s lecture illustrates how SAR data can be applied to assess war-related damage. Earth observation (EO) satellite missions offer a cost-effective and repeatable solution for monitoring war impacts. Due to their relatively low spatial resolution, the Landsat series enables faster image processing and lower computational demands. However, its spatial resolution is insufficient for detecting changes at the building level. As a result, it is difficult to assess the extent of structural damage in urban areas. Therefore, war monitoring using Landsat data has focused on broader environmental changes, lacking direct insight into urban structural damage (e.g., buildings). That limits the ability to quantitatively assess socio-economic losses. <span class="citation" data-cites="kaplan2022b">(<a href="#ref-kaplan2022b" role="doc-biblioref">Kaplan et al. 2022</a>)</span></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/wk9landsat.png" class="img-fluid figure-img" width="400"></p>
<figcaption>pre- and post-war changes :<span class="citation" data-cites="castillejo-gonzález2009">Castillejo-González et al. (<a href="#ref-castillejo-gonzález2009" role="doc-biblioref">2009</a>)</span></figcaption>
</figure>
</div>
<p>Sentinel-1 and Sentinel-2 have higher resolution, so they are widely used in the study of urban change and damage to buildings caused by war. Most of the studies apply machine learning techniques to extract image features from Sentinel-2 and polarization features (e.g., VH, HH) from SAR data. Then, classifiers are used to evaluate building damage and classify war-affected areas.<span class="citation" data-cites="aimaiti2022 li2025 fakhri2021">(<a href="#ref-aimaiti2022" role="doc-biblioref">Aimaiti et al. 2022</a>; <a href="#ref-li2025" role="doc-biblioref">Li, Guo, and Chan 2025</a>; <a href="#ref-fakhri2021" role="doc-biblioref">Fakhri and Gkanatsios 2021</a>)</span> As previously discussed in Week 3, image features play a key role in urban classification and object identification. In terms of classification accuracy, MS-based data generally has higher overall accuracy than SAR-based data. The VH polarization in SAR data plays the most important role in detecting destroyed buildings. This may be due to their higher sensitivity to structural variations. SAR data is affected by speckle noise at low resolution. MS data captures features well but responds poorly to abrupt structural changes. <span class="citation" data-cites="li2025">Li, Guo, and Chan (<a href="#ref-li2025" role="doc-biblioref">2025</a>)</span> applied a Random Forest model to classify war-related features using fused Sentinel-1 SAR and Sentinel-2 MS data. Fused data achieved 95.91% accuracy, outperforming MS (95.01%) and SAR (78.65%).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/wk9DB.png" class="img-fluid figure-img" width="6500"></p>
<figcaption>Features Importance For Destroyed Building :<span class="citation" data-cites="li2025">Li, Guo, and Chan (<a href="#ref-li2025" role="doc-biblioref">2025</a>)</span></figcaption>
</figure>
</div>
<p>Although many articles emphasise the advantages of SAR’s independence from weather. I think the spatial distribution and extent of damage to the building are more important than continuous monitoring over time. <span class="citation" data-cites="aimaiti2022">Aimaiti et al. (<a href="#ref-aimaiti2022" role="doc-biblioref">2022</a>)</span> performed change detection by calculating the log ratio of backscatter intensity and GLCM texture difference. The process then continued with classification, avoiding two-stage model training and improving overall efficiency.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/Wk9s1s2.png" class="img-fluid figure-img" width="6500"></p>
<figcaption>Sentinel-1 vs Sentinel-2 :<span class="citation" data-cites="aimaiti2022">Aimaiti et al. (<a href="#ref-aimaiti2022" role="doc-biblioref">2022</a>)</span></figcaption>
</figure>
</div>
</section>
<section id="reflection" class="level2">
<h2 class="anchored" data-anchor-id="reflection">Reflection</h2>
<p>SAR is now widely used in disaster assessment, including natural and war-related disasters. SAR is characterised by insensitivity to weather conditions, short acquisition cycles and high structural responsiveness. This week’s readings highlighted the importance of intensity ratios and polarization features in SAR-based analysis. The phase is also useful; it can detect slight ground movement. Interferometric SAR (InSAR) techniques have already been used to detect landslides, due to their ability to capture small-scale deformations. Is it possible to identify localised ground disturbances caused by war (e.g.&nbsp;blast impacts)? Does that mean InSAR can be applied to war damage assessment? Through this week’s lecture, I gained knowledge about the importance of remote sensing images in disaster assessment. Automated remote sensing processes can provide disaster damage assessments in the first instance. It provides scientific evidence for the timely allocation of relief resources and thus better reflects the humanitarian spirit. Moreover, the data discussed this week is open-source, and its application helps reduce the development gap between countries. In the future, an open framework for international cooperation on disaster assessment could be developed, potentially contributing to the scientific coordination of humanitarian aid. Although such ideas face practical challenges such as data privacy and national sovereignty, their potential merits warrant further exploration.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-aimaiti2022" class="csl-entry" role="listitem">
Aimaiti, Yusupujiang, Christina Sanon, Magaly Koch, Laurie G. Baise, and Babak Moaveni. 2022. <span>“War Related Building Damage Assessment in Kyiv, Ukraine, Using Sentinel-1 Radar and Sentinel-2 Optical Images.”</span> <em>Remote Sensing</em> 14 (24): 6239. <a href="https://doi.org/10.3390/rs14246239">https://doi.org/10.3390/rs14246239</a>.
</div>
<div id="ref-castillejo-gonzález2009" class="csl-entry" role="listitem">
Castillejo-González, Isabel Luisa, Francisca López-Granados, Alfonso García-Ferrer, José Manuel Peña-Barragán, Montserrat Jurado-Expósito, Manuel Sánchez De La Orden, and María González-Audicana. 2009. <span>“Object- and Pixel-Based Analysis for Mapping Crops and Their Agro-Environmental Associated Measures Using QuickBird Imagery.”</span> <em>Computers and Electronics in Agriculture</em> 68 (2): 207–15. <a href="https://doi.org/10.1016/j.compag.2009.06.004">https://doi.org/10.1016/j.compag.2009.06.004</a>.
</div>
<div id="ref-fakhri2021" class="csl-entry" role="listitem">
Fakhri, Falah, and Ioannis Gkanatsios. 2021. <span>“Integration of Sentinel-1 and Sentinel-2 Data for Change Detection: A Case Study in a War Conflict Area of Mosul City.”</span> <em>Remote Sensing Applications: Society and Environment</em> 22 (April): 100505. <a href="https://doi.org/10.1016/j.rsase.2021.100505">https://doi.org/10.1016/j.rsase.2021.100505</a>.
</div>
<div id="ref-kaplan2022b" class="csl-entry" role="listitem">
Kaplan, Gordana, Tatjana Rashid, Mateo Gasparovic, Andrea Pietrelli, and Vincenzo Ferrara. 2022. <span>“Monitoring War-Generated Environmental Security Using Remote Sensing: A Review.”</span> <em>Land Degradation and Development</em> 33 (10): 1513–26. <a href="https://doi.org/10.1002/ldr.4249">https://doi.org/10.1002/ldr.4249</a>.
</div>
<div id="ref-li2025" class="csl-entry" role="listitem">
Li, Xinchen, Liang Guo, and Jonathan Cheung-Wai Chan. 2025. <span>“Combined Sentinel-1 and Sentinel-2 Imagery for Destroyed Building Classification in Gaza Strip with Random Forest.”</span> <em>IEEE Journal of Selected Topics in Applied Earth Observations and Remote Sensing</em> 18: 3827–39. <a href="https://doi.org/10.1109/JSTARS.2024.3522389">https://doi.org/10.1109/JSTARS.2024.3522389</a>.
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>